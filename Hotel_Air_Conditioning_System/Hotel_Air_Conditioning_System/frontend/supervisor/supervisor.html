<html>

<head>
    <meta charset="UTF-8" />
    <script src="./resource/handsontable/dist/handsontable.full.js"></script>
    <script src="./resource/handsontable/dist/languages/zh-CN.js"></script>
    <link href="./resource/handsontable/dist/handsontable.full.css" rel="stylesheet" media="screen">
</head>

<body>
    <button onclick="refresh()">刷新</button>
    <br>
    <input id="inputId" type="text">
    <!--入住、退房功能的参数，含义为房号-->
    <button onclick="checkIn()">入住</button>
    <button onclick="checkOut()">退房</button>
    <div id="table"></div>
</body>
<script> // data
    const BaseURL = "http://.../info/";
    var opTimeout = 3000;
    var data = [
        { id: 1, liveIn: true, bill: 0.0, temp: 25, on: false },
        { id: 2, liveIn: false, bill: 21.1, temp: 21, on: true, target: 21, },
        { id: 3, liveIn: false, bill: 1.4, temp: 25, on: true, target: 25, },
        { id: 4, liveIn: false, bill: 0.6, temp: 26, on: true, target: 23, },
        { id: 5, liveIn: false, bill: 5.8, temp: 25, on: true, target: 21, },
    ];
    var container = document.getElementById('table');
    var hot = new Handsontable(container, {
        language: "zh-CN",
        filters: true,
        multiColumnSorting: true,
        allowInsertColumn: false,
        allowInsertRow: false,
        allowRemoveColumn: false,
        allowRemoveRow: false,
        dropdownMenu: ['filter_by_condition', 'filter_by_value', 'filter_action_bar'],
        dataSchema: { id: null, liveIn: null, bill: null, on: null, temp: null, target: null },
        colHeaders: ["房号", "入住", "计价", "室温", "开关", "标温"],
        columns: [
            { data: "id", type: 'numeric', className: "htCenter", editor: false },
            { data: "liveIn", type: 'text', className: "htCenter", editor: false },
            { data: "bill", type: 'numeric', className: "htRight", editor: false },
            { data: "temp", type: 'numeric', className: "htCenter", editor: false },
            { data: "on", type: 'text', className: "htCenter", editor: false },
            { data: "target", type: 'numeric', className: "htCenter", editor: false }
        ],
        data: data
    });
</script>
<script> // refresh
    var refreshRequest = new XMLHttpRequest();
    refreshRequest.onreadystatechange = function () {
        if (refreshRequest.readyState == 4) {
            if (refreshRequest.status == 200) {
                data = JSON.parse(refreshRequest.responseText);
            }
            else {
                console.error("refresh status error:" + refreshRequest.status);
                alert("刷新失败");
            }
        }
    }
    refreshRequest.ontimeout = function () {
        alert("服务器响应超时，请联系管理员");
        console.error("刷新超时");
    }
    function refresh() { //fetch real-time data from server
        refreshRequest.open("POST", BaseURL + "refresh", true);
        refreshRequest.responseType = "json";
        refreshRequest.timeout = opTimeout;
        refreshRequest.send();
    }
    //var refreshInterval = setInterval("refresh()", 10000);
</script>
<script> // business logic
    var bill;
    var inputId = document.getElementById(inputId);
    var checkInRequest = new XMLHttpRequest();
    var checkOutRequest = new XMLHttpRequest();
    checkInRequest.onreadystatechange = function () {
        if (checkInRequest.status == 200) {
            alert("入住成功");
            refresh();
        }
        else {
            console.error("checkIn status error:" + checkInRequest.status);
            alert("入住操作失败");
        }
    }
    checkInRequest.ontimeout = function () {
        alert("服务器响应超时，请联系管理员");
        console.error("入住操作超时");
    }
    checkOutRequest.onreadystatechange = function () {
        if (checkOutRequest.status == 200) {
            alert("总额:" + checkOutRequest.responseText);// bill returned
            refresh();
        }
        else {
            console.error("checkOut status error:" + checkOutRequest.status);
            alert("退房操作失败");
        }
    }
    checkOutRequest.ontimeout = function () {
        alert("服务器响应超时，请联系管理员");
        console.error("退房操作超时");
    }
    function checkIn() { //checkin operation
        checkInRequest.open("POST", BaseURL + "checkIn", true);
        checkInRequest.timeout = opTimeout;
        checkInRequest.send(inputId.value);
    }
    function checkOut() { //checkin operation
        checkOutRequest.open("POST", BaseURL + "checkOut", true);
        checkOutRequest.timeout = opTimeout;
        checkOutRequest.send(inputId.value);
    }
</script>

</html>